<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PVE electrified web build</title>
</head>
<body>
  <div id="content">Fetching state</div>
  <div id="forNonWebBuildControlPage" style="display: none;margin-top:16px">
      <div id="cleanRebuildButtonPanel" style="display: none;margin-bottom: 8px">Troubleshoot: <button onclick="(async() => { await execElectrifiedApiMethod('disablePluginsAndRebuildClean',[]);})()">Disable all plugins and do a clean rebuild</button></div>
      <i>For developers:</i> <a href="/webBuild" target="webBuild">Open web build control panel</a>
  </div>
  <form id="interactiveForm" style="display: none" onsubmit="event.preventDefault()">
      <hr/>
      <input id="useViteDevServerCheckbox" type="checkbox" onclick="rebuild({...state.builtWeb.buildOptions, buildStaticFiles: !event.target.checked})"/>Use vite devserver<br/>
      &#160;└<input id="viteDevServer_allowUnauthorizedClients_checkbox" type="checkbox" onclick="withErrorHandling(async() => { await execElectrifiedApiMethod('setViteDevServer_allowUnauthorizedClients',[event.target.checked]);})"/>Allow unauthorized clients (not secure for production use)<br/>
      &#160;└<input id="node_env_development_checkbox" type="checkbox" onclick="withErrorHandling(async() => { await execElectrifiedApiMethod('setNodeEnv',[event.target.checked?'development':'production']);})"/>Set NODE_ENV=development - prevents vite devserver from minifying libraries (not secure for production use)<br/>
      <input id="enablePlugins" type="checkbox" onclick="rebuild({...state.builtWeb.buildOptions, enablePlugins: event.target.checked})"/>Enable plugins<br/>
      <br/>
      <button onclick="withErrorHandling(() => rebuild(state.builtWeb.buildOptions))">Rebuild web</button>
      <button onclick="withErrorHandling(async() => { await execElectrifiedApiMethod('resetNode_modules',[]);})">Reset node_modules</button>
      <button id="createExamplePluginProjectButton" onclick="withErrorHandling(async() => { await execElectrifiedApiMethod('createUiPluginProject',['example']);await rebuild({...state.builtWeb.buildOptions, buildStaticFiles: false});})">Create example ui plugin project</button>
      <button onclick="withErrorHandling(async() => { if(confirm('This will uninstall it and install the original pve-manager by Proxmox. Sure?')) { await execElectrifiedApiMethod('uninstallPveme',[]);}})">Uninstall pve-manager-electrified</button>
      <button onclick="withErrorHandling(logout)">Logout</button>
  </form>

  <form id="loginForm" style="display: none" enctype="application/x-www-form-urlencoded" onsubmit="submitLoginForm(this); event.preventDefault();">
      <hr/>
      <h3>Login to PVE</h3>
      Please login to PVE to use the control panel above<br/><br/>
      <strong>User name: </strong><input type="text" name="username" value="root"/> @Realm: <input type="text" name="realm" value="pam"><br/>
      <strong>Password: </strong><input id="loginPassword" type="password" name="password"/> <br/>
      <input type="submit" value="login"/> <span id="loginMessage"></span>
  </form>

  <div id="plugin_developer_links" style="display: none">
      <hr/>
      <h2>Plugin developer links</h2>
      <table>
          <td><a href="https://github.com/bogeeee/pve-manager-electrified/blob/main/docs/plugin-development.md">Plugin development guide</a></td>
          <tr><td><a href="https://pve.proxmox.com/pve-docs/api-viewer/">PVE API Documentation</a></td><td>- use with: <code>this.app.api2fetch(...)</code></td></td></tr>
          <tr><td colspan="2"><strong><br/>UI</strong></td></tr>
          <tr><td><a href="https://blueprintjs.com/docs/#core">Blueprint</a></td></tr>
          <tr><td><a href="https://mui.com/material-ui/all-components/">Material UI</a></td></tr>
          <tr><td><a href="https://fontawesome.com/v4/icons/">Font Awesome icons</a></td></tr>
          <tr><td colspan="2"><strong><br/>UI frameworks</strong></td></tr>
          <tr><td><a href="https://18.react.dev">React 18</a></td></tr>
          <tr><td><a href="https://github.com/bogeeee/react-deepwatch">React Deepwatch</a></td></tr>
          <tr><td><a href="https://docs.sencha.com/extjs/6.7.0/modern/Ext.html">Ext JS 6</a></td></tr>


      </table>
  </div>


  <script type="text/javascript">
      Proxmox = $PROXMOXSTATE$;

      const loadingSpinnerHtml='<img src="data:image/gif;base64,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"/>'
      let state;

      async function fetchAndUpdateContent() {
          let contentHtml
          try {
              const isWebBuildControlPage = window.location.pathname.indexOf("/webBuild") === 0;
              if(!isWebBuildControlPage) {
                  document.getElementById("forNonWebBuildControlPage").style.display = "block";
              }

              state = await execElectrifiedApiMethod("getWebBuildState",[]);
              contentHtml = `
${isWebBuildControlPage?`
    <h2>Web build control panel</h2>
    <b>Source directory:</b> <i>${escapeHtml(state.wwwSourceDir)}</i><br/>
    ${Array.isArray(state.pluginSourceProjects)?state.pluginSourceProjects.map(p => `<b>Plugin source directory:</b> <i>${escapeHtml(p.dir)}</i><br/>`).join("\n"): `<b>Plugin source directory(s):</b> Error: ${escapeHtml(state.pluginSourceProjects)}<br/>`}
    <i>Build Id: ${escapeHtml(state.builtWeb.buildId)}</i><br/>
    Started ${escapeHtml(state.builtWeb.diagnosis_createdAt)}<br/>
`:""}
${state.builtWeb.promiseState.state==="pending"?`${loadingSpinnerHtml} ${isWebBuildControlPage?"<b>Building web:</b>":"<b>Building the web-ui for PVE-electrified. Please be patient.</b> Progress:"}</b> ${escapeHtml(state.builtWeb.diagnosis_state)}<br/>`:""}
${state.builtWeb.promiseState.state==="resolved"?`
<b>Build successfull.</b> ${state.builtWeb.buildOptions.buildStaticFiles?`Now serving from folder: <i>${escapeHtml(state.bundledWWWDir)}</i>`: `Serving with the vite devserver`}
`:""}
${state.builtWeb.promiseState.state==="rejected"?`<b>Build failed:</b> ${state.builtWeb.promiseState.rejectReason}<br/>`:""}
`
              if(isWebBuildControlPage) {
                  document.title = "Web build control panel"
                  // Update form:
                  document.getElementById("interactiveForm").style.display="block"
                  // Update checkboxes :
                  document.getElementById("useViteDevServerCheckbox").checked = !state.builtWeb.buildOptions.buildStaticFiles;
                  document.getElementById("viteDevServer_allowUnauthorizedClients_checkbox").checked = state.viteDevServer_allowUnauthorizedClients;
                  document.getElementById("viteDevServer_allowUnauthorizedClients_checkbox").disabled = state.builtWeb.buildOptions.buildStaticFiles;
                  document.getElementById("node_env_development_checkbox").checked = state.NODE_ENV === "development";
                  document.getElementById("node_env_development_checkbox").disabled = state.builtWeb.buildOptions.buildStaticFiles;

                  document.getElementById("enablePlugins").checked = state.builtWeb.buildOptions.enablePlugins;

                  document.getElementById("createExamplePluginProjectButton").disabled = state.exampleUiPluginProjectExist

                  // show/hide login panel:
                  document.getElementById("loginForm").style.display= state.hasPermissions?"none":"block";

                  // Show section:
                  document.getElementById("plugin_developer_links").style.display="block"
              }
              else {
                  if(state.builtWeb.promiseState.state==="rejected") {
                      document.getElementById("cleanRebuildButtonPanel").style.display="block";
                  }
                  if(state.builtWeb.promiseState.state==="resolved") { // Build was successful?
                      window.location.reload();
                  }
              }
          }
          catch (e) {
              contentHtml = `<i><pre>${escapeHtml(errorToString(e))}</pre></i>`
          }
          document.getElementById("content").innerHTML = contentHtml;
      }
      setInterval(fetchAndUpdateContent, 500); fetchAndUpdateContent();

      async function submitLoginForm(form) {
          const msgSpan = document.getElementById("loginMessage");
          msgSpan.innerHTML = loadingSpinnerHtml;

          let msg = ""
          try {
              const result = await (await better_fetch('/api2/json/access/ticket', {
                  method: 'POST',
                  body: new URLSearchParams(new FormData(form)).toString(),
                  headers: {'Content-Type': 'application/x-www-form-urlencoded'}
              })).json();
              document.cookie = `PVEAuthCookie=${escape(result.data.ticket)}; SameSite=lax; secure`
              await execElectrifiedApiMethod("ping",[]) // query/refresh the permissions
              msg = "Login successful"
              document.getElementById("loginPassword").value="";
          } catch (e) {
              msg = "Login failed.";
          }

          msgSpan.textContent = msg;
      }

      async function logout() {
          window.document.cookie = "PVEAuthCookie=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
          window.localStorage.removeItem("ProxmoxUser");
          await execElectrifiedApiMethod("clearCachedPermissions", []);
          document.getElementById("loginMessage").innerHTML = "";
      }


      async function rebuild(options) {
          withErrorHandling(() => execElectrifiedApiMethod("rebuildWebAsync", [options]));
      }

      async function execElectrifiedApiMethod(methodName, args) {
          return await (await better_fetch(`electrifiedAPI/${methodName}`, {method: "POST", headers: {"Content-Type": "application/json", csrfProtectionMode: "corsReadToken"}, body: JSON.stringify(args)})).json()
      }

      // *** UTIL Functions ***
      async function better_fetch(...args) {
          const request = args[0];
          let result;
          try {
              result = await fetch(...args);
          }
          catch (e) {
              if((e)?.message === "fetch failed") {
                  // Throw with a better message
                  throw new Error(`could not fetch url: ${request?.url?request.url:request.toString()}${ ((e)?.cause?.message)?`: ${(e).cause.message}`:""}`, {cause: e});
              }
              throw e;
          }

          if(!result.ok) {
              // Try to get content
              let content = "";
              try {
                  content = " content:\n" + await result.text();
              }
              catch(e) {}

              throw new Error(`could not fetch url: ${request?.url?request.url:request.toString()}:  ${result.status}: ${result.statusText}${content}`)
          }
          return result;
      }

      function escapeHtml(unsafe) {
          return unsafe
              .replace(/&/g, "&amp;")
              .replace(/</g, "&lt;")
              .replace(/>/g, "&gt;")
              .replace(/"/g, "&quot;")
              .replace(/'/g, "&#039;");
      }

      function errorToString(e) {
          // Handle other types:
          if (!e || typeof e !== "object") {
              return String(e);
          }
          if (!e.message) { // e is not an ErrorWithExtendedInfo ?
              return JSON.stringify(e);
          }

          return (e.name ? `${e.name}: ` : "") + (e.message || String(e)) +
              (e.stack ? `\n${e.stack}` : '') +
              (e.fileName ? `\nFile: ${e.fileName}` : '') + (e.lineNumber ? `, Line: ${e.lineNumber}` : '') + (e.columnNumber ? `, Column: ${e.columnNumber}` : '') +
              (e.cause ? `\nCause: ${errorToString(e.cause)}` : '')
      }

      async function withErrorHandling(fn) {
          try {
              await fn()
          }
          catch (e) {
              alert(errorToString(e));
          }
      }
  </script>
</body>
</html>